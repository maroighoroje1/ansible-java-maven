name: Ansible Deployment Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  ANSIBLE_SERVER: "3.94.106.38"
  ANSIBLE_USER: "ubuntu"  # Changed from root to ubuntu
  ANSIBLE_REMOTE_DIR: "/home/ubuntu"  # Changed from /root to /home/ubuntu

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH environment
        env:
          ANSIBLE_SSH_KEY: ${{ secrets.ANSIBLE_SERVER_KEY }}
          EC2_SSH_KEY: ${{ secrets.EC2_SERVER_KEY }}
        run: |
          # Create SSH directory with proper permissions
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Setup Ansible server SSH key
          echo "$ANSIBLE_SSH_KEY" > ~/.ssh/ansible_key
          chmod 600 ~/.ssh/ansible_key
          
          # Setup EC2 SSH key for transfer
          echo "$EC2_SSH_KEY" > ~/.ssh/ec2_key.pem
          chmod 600 ~/.ssh/ec2_key.pem
          
          # Add server to known_hosts (suppress output)
          ssh-keyscan -H $ANSIBLE_SERVER >> ~/.ssh/known_hosts 2>/dev/null || true
          
          echo "SSH environment setup completed"

      - name: Verify connectivity
        env:
          ANSIBLE_SSH_KEY: ${{ secrets.ANSIBLE_SERVER_KEY }}
        run: |
          echo "Testing connection to Ansible server..."
          
          ssh -i ~/.ssh/ansible_key \
            -o StrictHostKeyChecking=no \
            -o BatchMode=yes \
            -o ConnectTimeout=10 \
            -o LogLevel=ERROR \
            $ANSIBLE_USER@$ANSIBLE_SERVER 'echo "Connection successful as $USER"' || {
            echo "Failed to connect to Ansible server"
            exit 1
          }

      - name: Transfer files using SFTP
        env:
          ANSIBLE_SSH_KEY: ${{ secrets.ANSIBLE_SERVER_KEY }}
        run: |
          echo "Transferring Ansible files via SFTP..."
          
          # Create remote directory first
          ssh -i ~/.ssh/ansible_key \
            -o StrictHostKeyChecking=no \
            -o BatchMode=yes \
            -o LogLevel=ERROR \
            $ANSIBLE_USER@$ANSIBLE_SERVER \
            "mkdir -p $ANSIBLE_REMOTE_DIR/ansible-deployment"
          
          # Use SFTP batch mode to transfer files
          if [ -d "ansible" ]; then
            # Create SFTP batch file
            cat > /tmp/sftp_batch <<EOF
          cd $ANSIBLE_REMOTE_DIR/ansible-deployment
          put -r ansible/*
          EOF
            
            # Execute SFTP transfer
            sftp -i ~/.ssh/ansible_key \
              -o StrictHostKeyChecking=no \
              -o BatchMode=yes \
              -o LogLevel=ERROR \
              -b /tmp/sftp_batch \
              $ANSIBLE_USER@$ANSIBLE_SERVER
            
            echo "Ansible files transferred successfully"
          else
            echo "Error: ansible directory not found"
            exit 1
          fi
          
          # Transfer EC2 SSH key using SFTP
          # Expand $HOME before writing to batch file
          cat > /tmp/sftp_key_batch <<EOFKEY
          cd $ANSIBLE_REMOTE_DIR
          put $HOME/.ssh/ec2_key.pem ssh-key.pem
          EOFKEY
          
          sftp -i ~/.ssh/ansible_key \
            -o StrictHostKeyChecking=no \
            -o BatchMode=yes \
            -o LogLevel=ERROR \
            -b /tmp/sftp_key_batch \
            $ANSIBLE_USER@$ANSIBLE_SERVER
          
          # Set proper permissions on remote files
          ssh -i ~/.ssh/ansible_key \
            -o StrictHostKeyChecking=no \
            -o BatchMode=yes \
            -o LogLevel=ERROR \
            $ANSIBLE_USER@$ANSIBLE_SERVER \
            "chmod 600 $ANSIBLE_REMOTE_DIR/ssh-key.pem"
          
          echo "EC2 SSH key transferred successfully"

      - name: Prepare Ansible server
        env:
          ANSIBLE_SSH_KEY: ${{ secrets.ANSIBLE_SERVER_KEY }}
        run: |
          echo "Preparing Ansible server environment..."
          
          if [ -f "prepare-ansible-server.sh" ]; then
            # Transfer preparation script using SFTP
            cat > /tmp/sftp_prep_batch <<EOFPREP
          cd $ANSIBLE_REMOTE_DIR
          put prepare-ansible-server.sh
          EOFPREP
            
            sftp -i ~/.ssh/ansible_key \
              -o StrictHostKeyChecking=no \
              -o BatchMode=yes \
              -o LogLevel=ERROR \
              -b /tmp/sftp_prep_batch \
              $ANSIBLE_USER@$ANSIBLE_SERVER
            
            echo "Preparation script transferred, executing with sudo..."
            
            # Execute preparation script with sudo
            ssh -i ~/.ssh/ansible_key \
              -o StrictHostKeyChecking=no \
              -o BatchMode=yes \
              -o LogLevel=ERROR \
              $ANSIBLE_USER@$ANSIBLE_SERVER \
              "chmod +x $ANSIBLE_REMOTE_DIR/prepare-ansible-server.sh && \
               sudo bash $ANSIBLE_REMOTE_DIR/prepare-ansible-server.sh"
            
            echo "Server preparation completed"
          else
            echo "Warning: prepare-ansible-server.sh not found, skipping preparation"
          fi

      - name: Execute Ansible playbook
        env:
          ANSIBLE_SSH_KEY: ${{ secrets.ANSIBLE_SERVER_KEY }}
        run: |
          echo "Executing Ansible playbook..."
          
          ssh -i ~/.ssh/ansible_key \
            -o StrictHostKeyChecking=no \
            -o BatchMode=yes \
            -o LogLevel=ERROR \
            $ANSIBLE_USER@$ANSIBLE_SERVER \
            "cd $ANSIBLE_REMOTE_DIR/ansible-deployment && ansible-playbook my-playbook.yaml -v" || {
            echo "Ansible playbook execution failed"
            echo "Attempting to show playbook directory contents for debugging..."
            ssh -i ~/.ssh/ansible_key \
              -o StrictHostKeyChecking=no \
              -o BatchMode=yes \
              $ANSIBLE_USER@$ANSIBLE_SERVER \
              "ls -la $ANSIBLE_REMOTE_DIR/ansible-deployment/" || true
            exit 1
          }
          
          echo "Deployment completed successfully"

      - name: Cleanup sensitive files
        if: always()
        env:
          ANSIBLE_SSH_KEY: ${{ secrets.ANSIBLE_SERVER_KEY }}
        run: |
          echo "Cleaning up sensitive files from remote server..."
          
          ssh -i ~/.ssh/ansible_key \
            -o StrictHostKeyChecking=no \
            -o BatchMode=yes \
            -o LogLevel=ERROR \
            $ANSIBLE_USER@$ANSIBLE_SERVER \
            "rm -f $ANSIBLE_REMOTE_DIR/ssh-key.pem \
                   $ANSIBLE_REMOTE_DIR/prepare-ansible-server.sh" || true
          
          echo "Cleanup completed"

      - name: Deployment summary
        if: success()
        run: |
          echo "=========================================="
          echo "Deployment Summary"
          echo "=========================================="
          echo "Status: SUCCESS"
          echo "Target: $ANSIBLE_SERVER"
          echo "User: $ANSIBLE_USER"
          echo "Time: $(date)"
          echo "=========================================="